import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Button } from "@/components/ui/button";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { DollarSign, TrendingDown, Calculator, Save, Zap, CreditCard } from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";

const CREDIT_TIERS = {
  excellent: { range: "760-850", apr: 0.0375, badge: "Excellent", color: "from-green-500 to-emerald-500" },
  good: { range: "700-759", apr: 0.055, badge: "Good", color: "from-blue-500 to-cyan-500" },
  fair: { range: "640-699", apr: 0.085, badge: "Fair", color: "from-yellow-500 to-orange-500" },
  poor: { range: "<640", apr: 0.16, badge: "Poor", color: "from-red-500 to-pink-500" }
};

export default function FinanceCalculator({ vehicle, onSaveQuote }) {
  const [financeType, setFinanceType] = useState('loan');
  const [downPayment, setDownPayment] = useState(vehicle?.list_price ? Math.round(vehicle.list_price * 0.1) : 5000);
  const [tradeInValue, setTradeInValue] = useState(0);
  const [termMonths, setTermMonths] = useState(60);
  const [creditTier, setCreditTier] = useState('good');
  const [customApr, setCustomApr] = useState(null);
  const [fees, setFees] = useState(499);
  const [taxRate, setTaxRate] = useState(0.0825);
  const [residualPct, setResidualPct] = useState(0.50);

  const vehiclePrice = vehicle?.list_price || 30000;

  const calculateLoanPayment = () => {
    const apr = customApr !== null ? customApr : CREDIT_TIERS[creditTier].apr;
    const taxAmount = (vehiclePrice - tradeInValue) * taxRate;
    const principal = vehiclePrice - downPayment - tradeInValue + fees + taxAmount;
    
    if (principal <= 0) return { monthly: 0, totalInterest: 0, totalCost: principal };
    
    const r = apr / 12;
    let monthly;
    
    if (r === 0) {
      monthly = principal / termMonths;
    } else {
      monthly = principal * r / (1 - Math.pow(1 + r, -termMonths));
    }
    
    const totalCost = monthly * termMonths;
    const totalInterest = totalCost - principal;
    
    return {
      monthly: Math.round(monthly * 100) / 100,
      totalInterest: Math.round(totalInterest * 100) / 100,
      totalCost: Math.round(totalCost * 100) / 100,
      principal: Math.round(principal * 100) / 100
    };
  };

  const calculateLeasePayment = () => {
    const apr = customApr !== null ? customApr : CREDIT_TIERS[creditTier].apr;
    const msrp = vehicle?.msrp || vehiclePrice;
    const capCost = vehiclePrice - downPayment - tradeInValue + fees;
    const residualValue = msrp * residualPct;
    
    if (capCost <= 0) return { monthly: 0, totalCost: 0 };
    
    const depreciation = (capCost - residualValue) / termMonths;
    const moneyFactor = apr / 2400;
    const financeFee = (capCost + residualValue) * moneyFactor;
    const taxAmount = (depreciation + financeFee) * taxRate;
    const monthly = depreciation + financeFee + taxAmount;
    
    const totalCost = monthly * termMonths + downPayment;
    
    return {
      monthly: Math.round(monthly * 100) / 100,
      totalCost: Math.round(totalCost * 100) / 100,
      residualValue: Math.round(residualValue * 100) / 100
    };
  };

  const loanResult = calculateLoanPayment();
  const leaseResult = calculateLeasePayment();
  const result = financeType === 'loan' ? loanResult : leaseResult;

  const handleSave = () => {
    const quoteData = {
      vehicle_id: vehicle?.id,
      quote_type: financeType,
      vehicle_price: vehiclePrice,
      down_payment: downPayment,
      trade_in_value: tradeInValue,
      term_months: termMonths,
      apr: customApr !== null ? customApr : CREDIT_TIERS[creditTier].apr,
      monthly_payment: result.monthly,
      total_interest: loanResult.totalInterest || 0,
      total_cost: result.totalCost,
      residual_value: leaseResult.residualValue || 0,
      residual_percentage: residualPct,
      credit_tier: creditTier,
      state_tax_rate: taxRate,
      fees: fees
    };
    onSaveQuote && onSaveQuote(quoteData);
  };

  return (
    <Card className="border-0 shadow-2xl bg-white overflow-hidden">
      <CardHeader className="border-b bg-gradient-to-r from-blue-600 via-cyan-600 to-blue-600 text-white relative overflow-hidden">
        <div className="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9Ik0zNiAxOGMzLjMxIDAgNiAyLjY5IDYgNnMtMi42OSA2LTYgNi02LTIuNjktNi02IDIuNjktNiA2LTZ6TTI0IDQyYzMuMzEgMCA2IDIuNjkgNiA2cy0yLjY5IDYtNiA2LTYtMi42OS02LTYgMi42OS02IDYtNnoiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIuNSIgb3BhY2l0eT0iLjEiLz48L2c+PC9zdmc+')] opacity-20" />
        <div className="relative">
          <div className="flex items-center gap-3 mb-2">
            <div className="w-10 h-10 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center">
              <Calculator className="w-5 h-5" />
            </div>
            <CardTitle className="text-2xl font-black">Finance Calculator</CardTitle>
          </div>
          <p className="text-sm text-blue-100">Calculate your perfect payment plan</p>
        </div>
      </CardHeader>
      
      <CardContent className="p-6 space-y-6">
        <Tabs value={financeType} onValueChange={setFinanceType} className="w-full">
          <TabsList className="grid w-full grid-cols-2 h-12 bg-gradient-to-r from-gray-100 to-gray-50 p-1">
            <TabsTrigger value="loan" className="data-[state=active]:bg-white data-[state=active]:shadow-lg font-bold">
              üí∞ Finance (Loan)
            </TabsTrigger>
            <TabsTrigger value="lease" className="data-[state=active]:bg-white data-[state=active]:shadow-lg font-bold">
              üöó Lease
            </TabsTrigger>
          </TabsList>
          
          <div className="mt-6 space-y-6">
            {/* Vehicle Price Display */}
            <motion.div 
              initial={{ scale: 0.95 }}
              animate={{ scale: 1 }}
              className="relative overflow-hidden"
            >
              <div className="absolute inset-0 bg-gradient-to-r from-blue-500 to-cyan-500 opacity-5 rounded-2xl" />
              <div className="relative flex items-center justify-between p-6 bg-gradient-to-r from-gray-50 to-white rounded-2xl border-2 border-blue-100">
                <div>
                  <p className="text-sm font-bold text-gray-500 uppercase tracking-wider mb-1">Vehicle Price</p>
                  <p className="text-4xl font-black bg-gradient-to-r from-blue-600 to-cyan-600 bg-clip-text text-transparent">
                    ${vehiclePrice.toLocaleString()}
                  </p>
                </div>
                <div className="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-2xl flex items-center justify-center shadow-lg">
                  <CreditCard className="w-8 h-8 text-white" />
                </div>
              </div>
            </motion.div>

            {/* Down Payment */}
            <div>
              <Label htmlFor="down-payment" className="text-sm font-bold text-gray-900 mb-2 block">
                Down Payment
              </Label>
              <div className="flex gap-2">
                <div className="relative flex-1">
                  <DollarSign className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                  <Input
                    id="down-payment"
                    type="number"
                    value={downPayment}
                    onChange={(e) => setDownPayment(Number(e.target.value))}
                    className="pl-11 h-12 text-lg font-semibold border-2 border-gray-200 focus:border-blue-500 rounded-xl"
                  />
                </div>
                <Button
                  variant="outline"
                  onClick={() => setDownPayment(Math.round(vehiclePrice * 0.2))}
                  className="whitespace-nowrap h-12 px-6 font-bold border-2 border-gray-200 hover:border-blue-500 hover:bg-blue-50 rounded-xl"
                >
                  20%
                </Button>
              </div>
            </div>

            {/* Trade-in */}
            <div>
              <Label htmlFor="trade-in" className="text-sm font-bold text-gray-900 mb-2 block">
                Trade-in Value
              </Label>
              <div className="relative">
                <DollarSign className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                <Input
                  id="trade-in"
                  type="number"
                  value={tradeInValue}
                  onChange={(e) => setTradeInValue(Number(e.target.value))}
                  className="pl-11 h-12 text-lg font-semibold border-2 border-gray-200 focus:border-blue-500 rounded-xl"
                  placeholder="Optional"
                />
              </div>
            </div>

            {/* Term */}
            <div>
              <Label htmlFor="term" className="text-sm font-bold text-gray-900 mb-2 block">
                Loan Term
              </Label>
              <Select value={termMonths.toString()} onValueChange={(v) => setTermMonths(Number(v))}>
                <SelectTrigger className="h-12 text-lg font-semibold border-2 border-gray-200 rounded-xl">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="24">24 months</SelectItem>
                  <SelectItem value="36">36 months</SelectItem>
                  <SelectItem value="48">48 months</SelectItem>
                  <SelectItem value="60">60 months</SelectItem>
                  <SelectItem value="72">72 months</SelectItem>
                  <SelectItem value="84">84 months</SelectItem>
                </SelectContent>
              </Select>
            </div>

            {/* Credit Tier */}
            <div>
              <Label htmlFor="credit" className="text-sm font-bold text-gray-900 mb-2 block">
                Credit Score Range
              </Label>
              <Select value={creditTier} onValueChange={setCreditTier}>
                <SelectTrigger className="h-12 text-lg font-semibold border-2 border-gray-200 rounded-xl">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  {Object.entries(CREDIT_TIERS).map(([key, value]) => (
                    <SelectItem key={key} value={key} className="text-base">
                      <div className="flex items-center justify-between w-full">
                        <span className="font-bold">{value.badge}</span>
                        <span className="text-gray-500 ml-4">({value.range})</span>
                        <span className="text-blue-600 ml-4">{(value.apr * 100).toFixed(2)}%</span>
                      </div>
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {/* Lease Residual */}
            {financeType === 'lease' && (
              <div>
                <Label htmlFor="residual" className="text-sm font-bold text-gray-900 mb-2 block">
                  Residual Value %
                </Label>
                <Input
                  id="residual"
                  type="number"
                  step="0.01"
                  value={residualPct}
                  onChange={(e) => setResidualPct(Number(e.target.value))}
                  className="h-12 text-lg font-semibold border-2 border-gray-200 focus:border-blue-500 rounded-xl"
                />
                <p className="text-sm text-gray-500 mt-2">
                  Est. value at end: <span className="font-bold">${(residualPct * (vehicle?.msrp || vehiclePrice)).toLocaleString()}</span>
                </p>
              </div>
            )}

            {/* Result - Enhanced */}
            <AnimatePresence mode="wait">
              <motion.div
                key={`${financeType}-${result.monthly}`}
                initial={{ scale: 0.9, opacity: 0, y: 20 }}
                animate={{ scale: 1, opacity: 1, y: 0 }}
                exit={{ scale: 0.9, opacity: 0, y: -20 }}
                transition={{ type: "spring", duration: 0.5 }}
                className="relative overflow-hidden"
              >
                <div className="absolute inset-0 bg-gradient-to-br from-blue-600 via-cyan-600 to-blue-600 opacity-100 rounded-3xl" />
                <div className="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9Ik0zNiAxOGMzLjMxIDAgNiAyLjY5IDYgNnMtMi42OSA2LTYgNi02LTIuNjktNi02IDIuNjktNiA2LTZ6TTI0IDQyYzMuMzEgMCA2IDIuNjkgNiA2cy0yLjY5IDYtNiA2LTYtMi42OS02LTYgMi42OS02IDYtNnoiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIuNSIgb3BhY2l0eT0iLjEiLz48L2c+PC9zdmc+')] opacity-20" />
                
                <div className="relative p-8">
                  <div className="flex items-center gap-2 mb-3">
                    <Zap className="w-5 h-5 text-yellow-300" />
                    <p className="text-sm font-bold text-blue-100 uppercase tracking-wider">Your Monthly Payment</p>
                  </div>
                  <p className="text-6xl font-black text-white mb-4">
                    ${result.monthly.toLocaleString()}
                  </p>
                  <div className="flex items-center justify-between text-blue-100 text-sm">
                    <span>
                      {financeType === 'loan' ? (
                        <>üí∞ Total interest: ${loanResult.totalInterest?.toLocaleString()}</>
                      ) : (
                        <>üéØ Total cost: ${result.totalCost?.toLocaleString()}</>
                      )}
                    </span>
                    <TrendingDown className="w-5 h-5" />
                  </div>
                </div>
              </motion.div>
            </AnimatePresence>

            {/* Disclaimer */}
            <div className="text-xs text-gray-600 p-4 bg-yellow-50 rounded-xl border-2 border-yellow-200">
              <strong className="text-yellow-800">‚ö†Ô∏è Disclaimer:</strong> Monthly estimates are illustrative only. 
              Final terms depend on credit approval, dealer fees, and state regulations.
            </div>

            {/* Save Button */}
            {onSaveQuote && (
              <Button 
                onClick={handleSave} 
                className="w-full h-14 text-lg font-bold bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 rounded-xl shadow-xl shadow-red-500/30"
              >
                <Save className="w-5 h-5 mr-2" />
                Save This Quote
              </Button>
            )}
          </div>
        </Tabs>
      </CardContent>
    </Card>
  );
}
